doctype html
// tables.html, includes the gas algorithm, parsing the js files (due to errors when separating js script files), adding to table, plotting on Google Embed API's map, and using "Places" to plot nearby gas stations.
html(lang='en')
  head
    meta(charset='utf-8')
    meta(http-equiv='X-UA-Compatible', content='IE=edge')
    meta(name='viewport', content='width=device-width, initial-scale=1, shrink-to-fit=no')
    meta(name='description', content='')
    meta(name='author', content='')
    
    title Gas Algorithm
    link.js-site-favicon(rel='icon', type='image/x-icon', href='vqlogo.ico')
    // Bootstrap core CSS
    link(href='vendor/bootstrap/css/bootstrap.min.css', rel='stylesheet')
    // Custom fonts for this template
    link(href='vendor/font-awesome/css/font-awesome.min.css', rel='stylesheet', type='text/css')
    // Page level plugin CSS
    link(href='vendor/datatables/dataTables.bootstrap4.css', rel='stylesheet')
    // Custom styles for this template
    link(href='css/sb-admin.css', rel='stylesheet')
    
    
    // Bootstrap core JavaScript

    script(src='vendor/jquery/jquery.min.js')
    script(src='vendor/bootstrap/js/bootstrap.bundle.min.js')
    // Core plugin JavaScript
    script(src='vendor/jquery-easing/jquery.easing.min.js')
    // Page level plugin JavaScript
    script(src='vendor/datatables/jquery.dataTables.js')
    script(src='vendor/datatables/dataTables.bootstrap4.js')
    // Custom scripts for all pages
    script(src='js/sb-admin.min.js')
    // Custom scripts for this page
    script(src='js/sb-admin-datatables.min.js')
    // jQuery plugin files for parsing xlsx
    // <script src="jquery-1.10.2.min.js" type="text/javascript"></script>
    // jQuery plugin files for parsing xlsx
    script(src=' https://code.jquery.com/jquery-1.10.2.min.js', type='text/javascript')
    script(src='https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.7.7/xlsx.core.min.js')
    script(src='https://cdnjs.cloudflare.com/ajax/libs/xls/0.7.4-a/xls.core.min.js')
    // Script file for adding to bootstrap table
    script(type='text/javascript', src='js/parse.js')
    
        
    script(src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js")
    script(src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js")
    script(type='text/javascript', src='/ajax-cross-origin/js/jquery.ajax-cross-origin.min.js')
    
    script(src='/testajaxss.js')
  body#page-top.fixed-nav.sticky-footer.bg-dark
    // Navigation
    nav#mainNav.navbar.navbar-expand-lg.navbar-dark.bg-dark.fixed-top
      a.navbar-brand(href='index.html')
        | Valuqo  
        img(src='vqlogo.png', alt='vqlogo', height='18', width='18')
      button.navbar-toggler.navbar-toggler-right(type='button', data-toggle='collapse', data-target='#navbarResponsive', aria-controls='navbarResponsive', aria-expanded='false', aria-label='Toggle navigation')
        span.navbar-toggler-icon
      #navbarResponsive.collapse.navbar-collapse
        ul#exampleAccordion.navbar-nav.navbar-sidenav
          li.nav-item(data-toggle='tooltip', data-placement='right', title='Dashboard')
            a.nav-link(href='index.html')
              i.fa.fa-fw.fa-dashboard
              span.nav-link-text Dashboard
          li.nav-item(data-toggle='tooltip', data-placement='right', title='Charts')
            a.nav-link(href='charts.html')
              i.fa.fa-fw.fa-area-chart
              span.nav-link-text Charts
          li.nav-item(data-toggle='tooltip', data-placement='right', title='Tables')
            a.nav-link(href='tables.html')
              i.fa.fa-fw.fa-table
              span.nav-link-text Gas Algorithm
          li.nav-item(data-toggle='tooltip', data-placement='right', title='Test Yodlee API')
            a.nav-link(href='http://valuqo.us-east-2.elasticbeanstalk.com/', target='_blank')
              i.fa.fa-fw.fa-link
              span.nav-link-text Webapp Demo
        ul.navbar-nav.ml-auto
          li.nav-item.dropdown
            a#messagesDropdown.nav-link.dropdown-toggle.mr-lg-2(href='#', data-toggle='dropdown', aria-haspopup='true', aria-expanded='false')
              i.fa.fa-fw.fa-envelope
              span.d-lg-none
                | Messages
                span.badge.badge-pill.badge-primary 12 New
              span.indicator.text-primary.d-none.d-lg-block
                i.fa.fa-fw.fa-circle
            .dropdown-menu(aria-labelledby='messagesDropdown')
              h6.dropdown-header New Messages:
              .dropdown-divider
              a.dropdown-item(href='#')
                strong David Miller
                span.small.float-right.text-muted 11:21 AM
                .dropdown-message.small
                  | Hey there! This new version of SB Admin is pretty awesome! These messages clip off when they reach the end of the box so they don't overflow over to the sides!
              .dropdown-divider
              a.dropdown-item(href='#')
                strong Jane Smith
                span.small.float-right.text-muted 11:21 AM
                .dropdown-message.small
                  | I was wondering if you could meet for an appointment at 3:00 instead of 4:00. Thanks!
              .dropdown-divider
              a.dropdown-item(href='#')
                strong John Doe
                span.small.float-right.text-muted 11:21 AM
                .dropdown-message.small
                  | I've sent the final files over to you for review. When you're able to sign off of them let me know and we can discuss distribution.
              .dropdown-divider
              a.dropdown-item.small(href='#') View all messages
          li.nav-item.dropdown
            a#alertsDropdown.nav-link.dropdown-toggle.mr-lg-2(href='#', data-toggle='dropdown', aria-haspopup='true', aria-expanded='false')
              i.fa.fa-fw.fa-bell
              span.d-lg-none
                | Alerts
                span.badge.badge-pill.badge-warning 6 New
              span.indicator.text-warning.d-none.d-lg-block
                i.fa.fa-fw.fa-circle
            .dropdown-menu(aria-labelledby='alertsDropdown')
              h6.dropdown-header New Alerts:
              .dropdown-divider
              a.dropdown-item(href='#')
                span.text-success
                  strong
                    i.fa.fa-long-arrow-up.fa-fw
                    | Status Update
                span.small.float-right.text-muted 11:21 AM
                .dropdown-message.small This is an automated server response message. All systems are online.
              .dropdown-divider
              a.dropdown-item(href='#')
                span.text-danger
                  strong
                    i.fa.fa-long-arrow-down.fa-fw
                    | Status Update
                span.small.float-right.text-muted 11:21 AM
                .dropdown-message.small This is an automated server response message. All systems are online.
              .dropdown-divider
              a.dropdown-item(href='#')
                span.text-success
                  strong
                    i.fa.fa-long-arrow-up.fa-fw
                    | Status Update
                span.small.float-right.text-muted 11:21 AM
                .dropdown-message.small This is an automated server response message. All systems are online.
              .dropdown-divider
              a.dropdown-item.small(href='#') View all alerts
          li.nav-item
            form.form-inline.my-2.my-lg-0.mr-lg-2
              .input-group
                input.form-control(type='text', placeholder='Search for...')
                span.input-group-append
                  button.btn.btn-primary(type='button')
                    i.fa.fa-search
          li.nav-item
            a.nav-link(data-toggle='modal', data-target='#exampleModal')
              i.fa.fa-fw.fa-sign-out
              | Logout
    .content-wrapper
      .container-fluid
        // Breadcrumbs
        ol.breadcrumb
          li.breadcrumb-item
            a(href='#') Dashboard
          li.breadcrumb-item.active Tables
        // Example DataTables Card
        // 
        p
          | To analyze gas expenditures, upload a .xlsx (Excel Workbook) of your expenses by clicking "Choose File" below.
        input#excelfile(type='file')
        input#viewfile(type='button', value='Export To Table', onclick='ExportToTable()')
        #data asdf
        #test1(style='display: block') asdf
        #test2(style='display: block') asdf
        #test3(style='display: block') asdf
        #datas asdf
        table#exceltablebr
        .card.mb-3
          .card-header
            i.fa.fa-table
            |  Data Table Example
          .card-body
            .table-responsive
              table#dataTable.table.table-bordered(width='100%', cellspacing='0')
                //
                  <thead>
                  <tr>
                  <th>Date</th>
                  <th>Expense</th>
                  <th>Amount</th>
                  </tr>
                  </thead>
                  <tfoot>
                  <tr>
                  <th>Date</th>
                  <th>Expense</th>
                  <th>Amount</th>
                  </tr>
                  </tfoot>
                  <tbody>
                  <tr>
                  <td>1/13/2018</td>
                  <td>Allentown Gas</td>
                  <td>$28.35</td>
                  </tr>
                  <tr>
                  <td>1/13/2018</td>
                  <td>Allentown Gas</td>
                  <td>$28.35</td>
                  </tr>
                  <tr>
                  <td>1/13/2018</td>
                  <td>Allentown Gas</td>
                  <td>$28.35</td>
                  </tr>
                  </tbody>
          .card-footer.small.text-muted Updated yesterday at 11:59 PM
        //
          <script src='https://maps.googleapis.com/maps/api/js?v=3.exp&key=AIzaSyDFCcHzzZgvH5aLn91I1kdvKfA1FT9ENmc'></script>
          <div style='overflow:hidden;height:400px;width:520px;'>
          <div id='gmap_canvas' style='height:400px;width:520px;'></div>
          <style>
          #gmap_canvas img {
          max-width: none !important;
          background: none !important
          }
          </style>
          </div>
          <a href='https://embedmaps.org/'>google maps html widget</a>
          <script type='text/javascript' src='https://embedmaps.com/google-maps-authorization/script.js?id=a36a21f0ca14e004e460d95709874e3ec29c478f'></script>
          <script type='text/javascript'>
          function init_map() {
          var myOptions = {
          zoom: 12,
          center: new google.maps.LatLng(40.1843574, -74.5740333),
          mapTypeId: google.maps.MapTypeId.ROADMAP
          };
          map = new google.maps.Map(document.getElementById('gmap_canvas'), myOptions);
          marker = new google.maps.Marker({
          map: map,
          position: new google.maps.LatLng(40.1843574, -74.5740333)
          });
          infowindow = new google.maps.InfoWindow({
          content: '<strong>Allentown Gas </strong><br>1650 Old York Rd<br>08501 Allentown<br>'
          });
          google.maps.event.addListener(marker, 'click', function() {
          infowindow.open(map, marker);
          });
          infowindow.open(map, marker);
          }
          google.maps.event.addDomListener(window, 'load', init_map);
          </script>
        script(src='https://maps.googleapis.com/maps/api/js?v=3.exp&key=AIzaSyDFCcHzzZgvH5aLn91I1kdvKfA1FT9ENmc')
        div(style='overflow:hidden;height:400px;width:520px;')
          #map(style='height:400px;width:520px;')
          style.
            #map img {
            max-width: none !important;
            background: none !important
            }
        a(href='https://embedmaps.org/')
          font(size='.1') .
        script(type='text/javascript', src='https://embedmaps.com/google-maps-authorization/script.js?id=a36a21f0ca14e004e460d95709874e3ec29c478f')
        script(type='text/javascript').
          var map;
          var centering = {
          lat: 40.1843574,
          lng: -74.5740333
          };
          var infowindow;
          var latLongPoints = [];
          var service;
          /*var locations = ["EXXONMOBIL NEW BRUNSWI NJ", "EXXONMOBIL JERSEY CITY NJ", "ALLENTOWN GASKO RTE. 539 @ 195 ALLENTOWN NJ", "ALLENTWON GASKO ALLENTOWN   NJ"];*/
          function initMap() {
          var bounds = new google.maps.LatLngBounds();
          var locations = newloc;
          console.log("Now locations are");
          console.log(locations);
          var mapProp = {
          center: centering,
          zoom: 8,
          panControl: true,
          /*In order to show navigating control*/
          zoomControl: true,
          mapTypeControl: true,
          scaleControl: true,
          streetViewControl: true,
          /*Enable street view control*/
          overviewMapControl: true,
          rotateControl: true,
          mapTypeId: google.maps.MapTypeId.ROADMAP
          };
          map = new google.maps.Map(document.getElementById('map'), mapProp);
          map.setTilt(45); /*To rotate map with an angle of 45 degree*/
          /* Draw all the expense points */
          for (i = 0; i < locations.length; i++) {
          /* Code to get Latitude and Longitude of location*/
          var locate = locations[i];
          console.log("locate" + locate);
          var geocoder = new google.maps.Geocoder();
          var address = locate;
          var points;
          var latitude;
          var longitude;
          geocoder.geocode({
          'address': address
          }, function(results, status) {
          if (status == google.maps.GeocoderStatus.OK) {
          latitude = results[0].geometry.location.lat();
          longitude = results[0].geometry.location.lng();
          points = new google.maps.LatLng(latitude, longitude);
          latLongPoints[i] = points;
          console.log(results[0]);
          console.log("Found place at" + locate + " latlong: " + latitude + " " + longitude);
          /* marker code*/
          console.log("---------------------------------------------------" + contains.call(results[0].types, 'gas_station'))
          if (contains.call(results[0].types, 'gas_station')) {
          var marker = new google.maps.Marker({
          position: points,
          map: map
          });
          /* Info window for primary gas station marker */
          google.maps.event.addListener(marker, 'click', function() {
          service = new google.maps.places.PlacesService(map);
          console.log(results[0].place_id);
          var plrequest = {
          placeId: results[0].place_id
          };
          service.getDetails(plrequest, function(result, status) {
          if (status !== google.maps.places.PlacesServiceStatus.OK) {
          console.error(status);
          return;
          }
          infoWindow = new google.maps.InfoWindow();
          infoWindow.setContent(result.name);
          infoWindow.open(map, marker);
          });
          });
          //extend the bounds to include each marker's position
          bounds.extend(marker.position);
          /* Now finding nearby gas stations
          var request = {
          location: results[0].geometry.location,
          radius: '5000',
          type: ['gas_station']
          };
          //console.log("doing search for nearby gas stations for:" + locate);
          //service = new google.maps.places.PlacesService(map);
          //service.nearbySearch(request, callback);*/
          }
          } else {
          console.log("geocoder failed for" + locate);
          }
          });
          }
          /*map.fitBounds(bounds);*/
          /* Draw home and work points */
          var homeAdd = sessionStorage.getItem("home_address");
          var workAdd = sessionStorage.getItem("work_address");
          var latitude1;
          var longitude1;
          var point1;
          var point2;
          console.log("Home Add is " + homeAdd + " and work Add is " + workAdd);
          var geocoder1 = new google.maps.Geocoder();
          geocoder1.geocode({
          'address': homeAdd
          }, function(results, status) {
          if (status == google.maps.GeocoderStatus.OK) {
          latitude1 = results[0].geometry.location.lat();
          longitude1 = results[0].geometry.location.lng();
          point1 = new google.maps.LatLng(latitude1, longitude1);
          var marker = new google.maps.Marker({
          position: point1,
          map: map,
          icon: {
          url: 'home.png',
          scaledSize: new google.maps.Size(50, 50)
          }
          });
          bounds.extend(marker.position);
          }
          });
          var geocoder2 = new google.maps.Geocoder();
          geocoder2.geocode({
          'address': workAdd
          }, function(results, status) {
          if (status == google.maps.GeocoderStatus.OK) {
          latitude1 = results[0].geometry.location.lat();
          longitude1 = results[0].geometry.location.lng();
          point2 = new google.maps.LatLng(latitude1, longitude1);
          var marker = new google.maps.Marker({
          position: point2,
          map: map,
          icon: {
          url: 'work.png',
          scaledSize: new google.maps.Size(50, 50)
          }
          });
          bounds.extend(marker.position);
          }
          });
          /*web scraping for lowest fuel price
          var pathHome = "https://www.gasbuddy.com/home?search="+encodeURIComponent(homeAdd)+"&fuel=1";
          var pathWork = "https://www.gasbuddy.com/home?search="+encodeURIComponent(workAdd)+"&fuel=1";
          var minPricep = {
          index : 0,
          price : 5,
          address : '',
          name : '',
          };
          var wminPricep = {
          index : 0,
          price : 5,
          address : '',
          name : '',
          };
          $.ajaxSetup({
          headers: {
          "Access-Control-Allow-Origin": "*",
          "Authority" :  document.authorizationToken,
          "Api-Version" : "1.1",
          "Cobrand-Name": "restserver"
          }
          });
          $.ajax({
          crossOrigin: true,
          url: pathHome,
          dataType: 'text',
          success: function(data) {
          console.log(typeof data);
          var priceStructs = $(data).find('.styles__price___3DxO5');
          var prices = [];
          for(var i = 0; i < priceStructs.length; i++){
          prices.push(priceStructs[i].innerText);
          if (parseFloat(priceStructs[i].innerText)<minPricep.price){
          minPricep.index = i;
          minPricep.price = parseFloat(priceStructs[i].innerText).toFixed(2);
          }
          }
          var addressesStructs = $(data).find('.styles__address___8IK98');
          minPricep.address = addressesStructs[minPricep.index].innerText;
          var addresses = [];
          for(var i = 0; i < addressesStructs.length; i++){
          addresses.push(addressesStructs[i].innerText);
          }
          var namesStructs = $(data).find('.ui.header.styles__stationNameHeader___24lb3');
          minPricep.name = namesStructs[minPricep.index].innerText;
          var names = [];
          for(var i = 0; i < namesStructs.length; i++){
          names.push(namesStructs[i].innerText);
          }
          console.log(prices);
          console.log(addresses);
          console.log(names);
          console.log(priceStructs);
          console.log($(data).find('.styles__price___3DxO5'));
          console.log(data);
          //var elements = $("<div>").html(data)[0];
          //console.log(elements);
          }
          });
          $.ajax({
          crossOrigin: true,
          url: pathWork,
          dataType: 'text',
          success: function(data) {
          console.log(typeof data);
          var priceStructs = $(data).find('.styles__price___3DxO5');
          var prices = [];
          for(var i = 0; i < priceStructs.length; i++){
          prices.push(priceStructs[i].innerText);
          if (priceStructs[i].innerText!='---' &&parseFloat(priceStructs[i].innerText)<wminPricep.price){
          wminPricep.index = i;
          wminPricep.price = parseFloat(priceStructs[i].innerText).toFixed(2);
          }
          }
          var addressesStructs = $(data).find('.styles__address___8IK98');
          wminPricep.address = addressesStructs[wminPricep.index].innerText;
          var addresses = [];
          for(var i = 0; i < addressesStructs.length; i++){
          addresses.push(addressesStructs[i].innerText);
          }
          var namesStructs = $(data).find('.ui.header.styles__stationNameHeader___24lb3');
          wminPricep.name = namesStructs[wminPricep.index].innerText;
          var names = [];
          for(var i = 0; i < namesStructs.length; i++){
          names.push(namesStructs[i].innerText);
          }
          console.log(prices);
          console.log(addresses);
          console.log(names);
          console.log(priceStructs);
          console.log($(data).find('.styles__price___3DxO5'));
          console.log(data);
          //var elements = $("<div>").html(data)[0];
          //console.log(elements);
          }
          });
          console.log("asdfasdfasdfasdf");
          console.log(minPricep);
          console.log("asdfasdfasdfasdfasdfas");
          console.log(wminPricep);*/
          /* draw route */
          var directionsService = new google.maps.DirectionsService();
          var directionsDisplay = new google.maps.DirectionsRenderer();
          //var start =  new google.maps.LatLng(latLongPoints[3]);
          // var end =  new google.maps.LatLng(latLongPoints[0]);
          //var start = new google.maps.LatLng(37.334818, -121.884886);
          // var end = new google.maps.LatLng(37.441883, -122.143019);
          var end = point2;
          var start = point1;
          //var waypts = [""]
          var request = {
          origin: homeAdd,
          destination: workAdd,
          //waypoints: 
          travelMode: google.maps.TravelMode.DRIVING
          };
          directionsService.route(request, function(response, status) {
          if (status == google.maps.DirectionsStatus.OK) {
          directionsDisplay.setDirections(response);
          directionsDisplay.setMap(map);
          } else {
          alert("Directions Request from " + latLongPoints[0] + " to " + latLongPoints[3] + " failed: " + status);
          }
          });
          }
          function callback(results, status) {
          if (status == google.maps.places.PlacesServiceStatus.OK) {
          for (var i = 0; i < results.length; i++) {
          var place = results[i];
          console.log('results of i')
          createMarker(results[i]);
          }
          }
          }
          function createMarker(place) {
          console.log("Found marker:" + place.geometry.location.lat() + ":" + place.geometry.location.lng());
          var marker = new google.maps.Marker({
          map: map,
          position: place.geometry.location,
          icon: {
          url: 'https://developers.google.com/maps/documentation/javascript/images/circle.png',
          anchor: new google.maps.Point(10, 10),
          scaledSize: new google.maps.Size(10, 17)
          }
          });
          google.maps.event.addListener(marker, 'click', function() {
          service.getDetails(place, function(result, status) {
          if (status !== google.maps.places.PlacesServiceStatus.OK) {
          console.error(status);
          return;
          }
          infoWindow.setContent(result.name);
          infoWindow.open(map, marker);
          });
          });
          }
          var contains = function(needle) {
          // Per spec, the way to identify NaN is that it is not equal to itself
          var findNaN = needle !== needle;
          var indexOf;
          if (!findNaN && typeof Array.prototype.indexOf === 'function') {
          indexOf = Array.prototype.indexOf;
          } else {
          indexOf = function(needle) {
          var i = -1,
          index = -1;
          for (i = 0; i < this.length; i++) {
          var item = this[i];
          if ((findNaN && item !== item) || item === needle) {
          index = i;
          break;
          }
          }
          return index;
          };
          }
          return indexOf.call(this, needle) > -1;
          };
        script(src='https://maps.googleapis.com/maps/api/js?key=AIzaSyDFCcHzzZgvH5aLn91I1kdvKfA1FT9ENmc&libraries=places', async='', defer='')
      // /.container-fluid
      // /.content-wrapper
      footer.sticky-footer
        .container
          .text-center
            small Copyright © Valuqo 2018
      // Scroll to Top Button
      a.scroll-to-top.rounded(href='#page-top')
        i.fa.fa-angle-up
      // Logout Modal
      #exampleModal.modal.fade(tabindex='-1', role='dialog', aria-labelledby='exampleModalLabel', aria-hidden='true')
        .modal-dialog(role='document')
          .modal-content
            .modal-header
              h5#exampleModalLabel.modal-title Ready to Leave?
              button.close(type='button', data-dismiss='modal', aria-label='Close')
                span(aria-hidden='true') ×
            .modal-body Select "Logout" below if you are ready to end your current session.
            .modal-footer
              button.btn.btn-secondary(type='button', data-dismiss='modal') Cancel
              a.btn.btn-primary(href='login.html') Logout
